<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI วิเคราะห์ความเสี่ยงสุขภาพ 7 ระดับ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Color Palette from Chart */
            --level1: #4dd0e1; --level2: #9ccc65; --level3: #4caf50; --level4: #fbc02d;
            --level5: #f57c00; --level6: #d32f2f; --level7: #000000;
            --primary-color: #007bff; --primary-hover: #0056b3; --background-color: #f8f9fa;
            --card-background: #fff; --text-color: #343a40; --heading-color: #004a7c;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--background-color); color: var(--text-color); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 2rem; line-height: 1.7; }
        .container { width: 100%; max-width: 750px; }
        .card { background-color: var(--card-background); padding: 2rem 2.5rem; border-radius: 16px; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08); }
        h1, h2, h3 { color: var(--heading-color); }
        h1 { text-align: center; margin-bottom: 0.5rem; }
        .subtitle { text-align: center; color: #6c757d; margin-top: 0; margin-bottom: 2rem; font-size: 1.1rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .full-width { grid-column: 1 / -1; }
        label { margin-bottom: 0.5rem; font-weight: 700; font-size: 0.95rem; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #ced4da; }
        input[type="text"]:focus, input[type="number"]:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
        .main-button { background: linear-gradient(45deg, var(--primary-color), #0056b3); color: white; border: none; font-weight: 700; cursor: pointer; transition: all 0.3s; width: 100%; margin-top: 2rem; padding: 16px; font-size: 1.2rem; border-radius: 12px; }
        .main-button:hover { box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3); transform: translateY(-2px); }

        /* Result Styles */
        .risk-summary-card { padding: 2rem; border-radius: 16px; color: white; text-align: center; margin-bottom: 2rem; }
        .risk-level-name { font-size: 2.5rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.2); margin: 0; }
        .result-section { margin-bottom: 2rem; }
        .result-section h3 { border-bottom: 2px solid #e9ecef; padding-bottom: 0.5rem; }
        .result-section ul { list-style: none; padding-left: 0; }
        .result-section li { background-position: left top 5px; background-repeat: no-repeat; padding-left: 30px; margin-bottom: 0.75rem; }
        .ai-summary { background-color: #e8f0fe; border-left: 5px solid #0056b3; padding: 1rem 1.5rem; border-radius: 8px; font-style: italic; }
        .advice-list li { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="%23198754" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>'); }
        .ai-recs-list li { background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="%230d6efd" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 16a6 6 0 0 0 6-6c0-1.633-.808-3.05-2.01-4.005a.5.5 0 0 0-.825.437c.39.87.635 1.85.635 2.868A4.5 4.5 0 0 1 8 14.5a.5.5 0 0 0 0 1M6.354 5.543A.5.5 0 0 0 6 6v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 0-1H7V6a.5.5 0 0 0-.646-.457M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0M7 5a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1z"/></svg>');}
        .final-note { border: 2px solid #f57c00; background-color: #fff8e1; color: #6d4c41; padding: 1.5rem; text-align: center; border-radius: 8px; font-weight: 500; }
        .loader { border: 5px solid #e9ecef; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 3rem auto; }
        .toggle-switch { display: flex; align-items: center; gap: 10px; font-weight:500; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<main class="container">
    <section id="app-card" class="card">
        <!-- Views will be switched here by JS -->
        <div id="form-wrapper">
            <h1>AI วิเคราะห์ความเสี่ยงสุขภาพ</h1>
            <p class="subtitle">ตามเกณฑ์ 7 ระดับกรมควบคุมโรค</p>
            <form id="health-form">
                <div class="form-grid">
                    <div class="form-group"><label for="name">ชื่อ</label><input type="text" id="name" placeholder="ชื่อของคุณ" required></div>
                    <div class="form-group"><label for="age">อายุ (ปี)</label><input type="number" id="age" placeholder="เช่น 45"></div>
                    <div class="form-group"><label for="weight">น้ำหนัก (กก.)</label><input type="number" id="weight" step="0.1" placeholder="เช่น 70.5"></div>
                    <div class="form-group"><label for="height">ส่วนสูง (ซม.)</label><input type="number" id="height" placeholder="เช่น 165"></div>

                    <div class="full-width"><h3>ผลตรวจสุขภาพ (ถ้ามี)</h3></div>
                    <div class="form-group"><label for="blood_sugar">ระดับน้ำตาลในเลือด (mg/dL)</label><input type="number" id="blood_sugar" placeholder="เจาะปลายนิ้วล่าสุด"></div>
                    <div class="form-group"><label for="hba1c">HbA1c (%)</label><input type="number" id="hba1c" step="0.1" placeholder="ถ้าทราบผลตรวจ"></div>
                    <div class="form-group"><label for="bp_sys">ความดัน (ตัวบน/Systolic)</label><input type="number" id="bp_sys" placeholder="เช่น 145"></div>
                    <div class="form-group"><label for="bp_dia">ความดัน (ตัวล่าง/Diastolic)</label><input type="number" id="bp_dia" placeholder="เช่น 95"></div>

                    <div class="full-width"><h3>อาการที่น่ากังวล</h3></div>
                    <div class="form-group full-width"><label for="symptoms">อธิบายอาการปัจจุบัน (ถ้ามี)</label><input type="text" id="symptoms" placeholder="เช่น ปวดหัวบ่อย, ตาพร่ามัว, ชาปลายมือ"></div>
                    <div class="form-group full-width toggle-switch">
                        <input type="checkbox" id="has_complications" style="width:auto; transform: scale(1.4);">
                        <label for="has_complications">มีอาการโรคแทรกซ้อนรุนแรงหรือไม่? (เช่น เจ็บหน้าอก, อัมพฤกษ์, ไตวาย)</label>
                    </div>
                </div>
                <button type="submit" class="main-button">วิเคราะห์ผล</button>
            </form>
        </div>

        <div id="loading-wrapper" style="display: none;">
             <div class="loader"></div>
             <h2 style="font-size: 1.5rem; text-align:center;">กำลังประมวลผลข้อมูล...</h2>
        </div>

        <div id="result-wrapper" style="display: none;"></div>
    </section>
</main>
<script>
    const appCard = document.getElementById('app-card');
    const healthForm = document.getElementById('health-form');

    function showView(viewId) {
        appCard.querySelectorAll('#form-wrapper, #loading-wrapper, #result-wrapper').forEach(v => v.style.display = 'none');
        document.getElementById(viewId).style.display = 'block';
    }

    healthForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showView('loading-wrapper');
        const formData = {
            name: document.getElementById('name').value, age: document.getElementById('age').value,
            weight: document.getElementById('weight').value, height: document.getElementById('height').value,
            blood_sugar: document.getElementById('blood_sugar').value, hba1c: document.getElementById('hba1c').value,
            bp_sys: document.getElementById('bp_sys').value, bp_dia: document.getElementById('bp_dia').value,
            symptoms: document.getElementById('symptoms').value,
            has_complications: document.getElementById('has_complications').checked
        };
        try {
            const response = await fetch('/api/assess', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
            if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.error); }
            const result = await response.json();
            displayResult(result);
            showView('result-wrapper');
        } catch (error) {
            displayError(error.message);
            showView('result-wrapper');
        }
    });

    function displayResult(data) {
        const { userInfo, riskProfile, aiAnalysis } = data;
        const resultContainer = document.getElementById('result-wrapper');
        resultContainer.innerHTML = `
            <div class="risk-summary-card" style="background: linear-gradient(45deg, ${riskProfile.color}, #333);">
                <p style="margin:0; font-size:1.1rem;">คุณ ${userInfo.name} อยู่ในกลุ่ม</p>
                <h2 class="risk-level-name" style="color:white;">${riskProfile.name}</h2>
                <p style="margin:0;">(ระดับ ${riskProfile.level}/7)</p>
            </div>
            
            <div class="result-section">
                <h3>บทวิเคราะห์จาก AI</h3>
                <p class="ai-summary">${aiAnalysis.overall_summary}</p>
            </div>

            <div class="result-section">
                <h3>ข้อปฏิบัติหลักตามเกณฑ์</h3>
                <ul class="advice-list">${riskProfile.advice.map(item => `<li>${item}</li>`).join('')}</ul>
            </div>
            
            <div class="result-section">
                <h3>คำแนะนำเพิ่มเติมจาก AI</h3>
                <ul class="ai-recs-list">${aiAnalysis.additional_recommendations.map(item => `<li>${item}</li>`).join('')}</ul>
            </div>

            <div class="final-note">${aiAnalysis.important_note}</div>

            <button id="reset-btn" class="main-button" style="margin-top: 2rem;">ประเมินอีกครั้ง</button>
        `;
        resultContainer.querySelector('#reset-btn').addEventListener('click', () => { healthForm.reset(); showView('form-wrapper'); });
    }
    
    function displayError(message){
        const resultContainer = document.getElementById('result-wrapper');
        resultContainer.innerHTML = `
             <h2 style="color:#d32f2f;">เกิดข้อผิดพลาด</h2>
             <p style="text-align:center; background-color: #f8d7da; padding: 1rem; border-radius: 8px;">${message}</p>
             <button id="reset-btn" class="main-button">กลับไปหน้าแรก</button>
        `;
        resultContainer.querySelector('#reset-btn').addEventListener('click', () => { healthForm.reset(); showView('form-wrapper'); });
    }
</script>
</body>
</html>