<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ประเมินอาการเบื้องต้น</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f7f9; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 2rem; }
        .container { width: 95%; max-width: 700px; }
        .card { background-color: #fff; padding: 2.5rem; border-radius: 12px; box-shadow: 0 4px M,h2 { color: #005a9c; text-align: center; }
        h3.section-title { color: #005a9c; border-bottom: 2px solid #eef2f5; padding-bottom: 0.75rem; margin-top: 2rem; margin-bottom: 1.5rem; font-size: 1.2rem; }
        .warning-box { background-color: #fffbe6; border: 1px solid #ffe58f; color: #d46b08; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; text-align: center; font-weight: 700; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .full-width { grid-column: 1 / -1; }
        label { margin-bottom: 0.5rem; font-weight: 700; color: #555; font-size: 0.9rem; }
        .checkbox-group-label { margin-bottom: 1rem; font-weight: 700; color: #555; grid-column: 1 / -1; }
        input[type="text"], input[type="number"], textarea, button { width: 100%; padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-family: 'Sarabun', sans-serif; }
        input:focus, textarea:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2); }
        textarea { resize: vertical; min-height: 100px; }
        button { background-color: #007bff; color: white; border: none; font-weight: 700; cursor: pointer; transition: background-color 0.3s; margin-top: 2rem; padding: 14px; font-size: 1.1rem; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #result-container { line-height: 1.7; }
        .result-section h3 { color: #005a9c; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem; margin-top: 1.5rem; }
        .result-section ul { list-style-type: '✓ '; padding-left: 1.5rem; }
        .result-section li { margin-bottom: 0.5rem; }
        .result-section .primary-analysis { background-color: #eef2f5; padding: 1rem; border-radius: 8px; margin-top: 0; font-style: italic; }
        .bmi-card { padding: 1rem; border-radius: 8px; text-align: center; font-size: 1.2rem; font-weight: bold; }
        .result-disclaimer { border: 2px solid #d93025; background-color: #fdecea; color: #a50e0e; padding: 1rem; margin-top: 2rem; border-radius: 8px; font-weight: 700; text-align: center; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 2rem auto; }
        .checkbox-container { display: flex; flex-wrap: wrap; gap: 10px 20px; }
        .checkbox-container label { display: flex; align-items: center; gap: 8px; font-weight: normal; font-size: 1rem;}
        input[type="checkbox"] { width: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } .card {padding: 1.5rem;} }
    </style>
</head>
<body>

<div class="container">
    <div class="card" id="form-card">
        <h1>AI ประเมินอาการเบื้องต้น</h1>
        <div class="warning-box">
            นี่ไม่ใช่การวินิจฉัยทางการแพทย์ โปรดใช้เพื่อเป็นข้อมูลประกอบและปรึกษาแพทย์หากมีอาการป่วย
        </div>
        <form id="health-form">
            <h3 class="section-title">ข้อมูลพื้นฐาน</h3>
            <div class="form-grid">
                <div class="form-group"><label for="name">ชื่อ</label><input type="text" id="name" placeholder="ระบุชื่อของคุณ" required></div>
                <div class="form-group"><label for="age">อายุ (ปี)</label><input type="number" id="age" placeholder="เช่น 35" required></div>
                <div class="form-group"><label for="weight">น้ำหนัก (กก.)</label><input type="number" id="weight" step="0.1" placeholder="เช่น 65.5" required></div>
                <div class="form-group"><label for="height">ส่วนสูง (ซม.)</label><input type="number" id="height" placeholder="เช่น 170" required></div>
            </div>
            
            <h3 class="section-title">รายละเอียดอาการ</h3>
            <div class="form-grid">
                 <div class="form-group full-width">
                    <label for="symptoms">อธิบายอาการหลักของคุณให้ละเอียดที่สุด</label>
                    <textarea id="symptoms" placeholder="เช่น มีไข้ ปวดหัวแบบตุบๆ มีน้ำมูกใส และไอมีเสมหะสีเหลือง" required></textarea>
                </div>
                <div class="form-group">
                    <label for="duration">อาการนี้เป็นมานานแค่ไหนแล้ว</label>
                    <input type="text" id="duration" placeholder="เช่น 2 วัน, ประมาณ 5 ชั่วโมง">
                </div>
                <div class="form-group">
                    <label for="severity">ให้คะแนนความรุนแรงของอาการ (0-10)</label>
                    <input type="number" id="severity" min="0" max="10" placeholder="0 = ไม่รุนแรง, 10 = ที่สุด">
                </div>
            </div>

            <h3 class="section-title">ข้อมูลสุขภาพเพิ่มเติม</h3>
            <div class="form-grid">
                <div class="checkbox-group-label">คุณมีโรคประจำตัวเหล่านี้หรือไม่ (เลือกได้หลายข้อ)</div>
                <div class="form-group full-width checkbox-container">
                    <label><input type="checkbox" name="conditions" value="เบาหวาน"> เบาหวาน</label>
                    <label><input type="checkbox" name="conditions" value="ความดันโลหิตสูง"> ความดันโลหิตสูง</label>
                    <label><input type="checkbox" name="conditions" value="โรคหัวใจ"> โรคหัวใจ</label>
                    <label><input type="checkbox" name="conditions" value="โรคไต"> โรคไต</label>
                    <label><input type="checkbox" name="conditions" value="หอบหืด/ภูมิแพ้"> หอบหืด/ภูมิแพ้</label>
                    <label><input type="checkbox" name="conditions" value="ไม่มี"> ไม่มี</label>
                </div>
                 <div class="form-group full-width">
                    <label for="conditions_other">โรคประจำตัวอื่นๆ (ถ้ามี)</label>
                    <input type="text" id="conditions_other" placeholder="ระบุโรคอื่นๆ">
                </div>
                <div class="form-group">
                    <label for="medications">ยา/อาหารเสริมที่ทานประจำ</label>
                    <input type="text" id="medications" placeholder="ระบุชื่อยา หรือ 'ไม่มี'">
                </div>
                <div class="form-group">
                    <label for="allergies">ประวัติแพ้ยา/แพ้อาหาร</label>
                    <input type="text" id="allergies" placeholder="ระบุสิ่งที่แพ้ หรือ 'ไม่มี'">
                </div>
            </div>
            
            <button type="submit" id="submit-btn">ส่งประเมินผล</button>
        </form>
    </div>

    <div class="card" id="result-container" style="display: none;">
        <!-- ผลลัพธ์จาก AI จะแสดงที่นี่ -->
    </div>
</div>

<script>
    const healthForm = document.getElementById('health-form');
    const submitBtn = document.getElementById('submit-btn');
    const resultContainer = document.getElementById('result-container');
    const formCard = document.getElementById('form-card');

    healthForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // --- ส่วนที่ปรับปรุง: การรวบรวมข้อมูลจากฟอร์มที่ซับซ้อนขึ้น ---
        
        // 1. รวบรวมโรคประจำตัวจาก Checkboxes
        const checkedConditions = Array.from(document.querySelectorAll('input[name="conditions"]:checked'))
                                       .map(cb => cb.value);
                                       
        // 2. เอารายชื่อโรคจากช่อง 'อื่นๆ' มารวมด้วย (ถ้ามี)
        const otherCondition = document.getElementById('conditions_other').value.trim();
        if (otherCondition) {
            checkedConditions.push(otherCondition);
        }
        
        // 3. จัดการกรณีที่เลือก 'ไม่มี' แต่ดันกรอกอย่างอื่นด้วย
        // ถ้า 'ไม่มี' อยู่ในรายการ ให้ใช้แค่ 'ไม่มี'
        const finalConditions = checkedConditions.includes('ไม่มี') 
                                ? 'ไม่มี' 
                                : checkedConditions.join(', ') || 'ไม่ได้ระบุ';

        // 4. สร้าง Object ที่จะส่งไป API
        const formData = {
            // ข้อมูลเดิม
            name: document.getElementById('name').value,
            age: document.getElementById('age').value,
            weight: document.getElementById('weight').value,
            height: document.getElementById('height').value,
            symptoms: document.getElementById('symptoms').value,
            // ข้อมูลใหม่
            duration: document.getElementById('duration').value || 'ไม่ได้ระบุ',
            severity: document.getElementById('severity').value || 'ไม่ได้ระบุ',
            chronic_conditions: finalConditions, // ใช้ค่าที่ประมวลผลแล้ว
            medications: document.getElementById('medications').value || 'ไม่มี',
            allergies: document.getElementById('allergies').value || 'ไม่มี'
        };
        // -------------------------------------------------------------------

        submitBtn.disabled = true;
        submitBtn.textContent = 'กำลังประมวลผล...';
        resultContainer.innerHTML = '<div class="loader"></div>';
        resultContainer.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });


        try {
            const response = await fetch('/api/assess', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'เกิดข้อผิดพลาดในการสื่อสารกับเซิร์ฟเวอร์');
            }

            const result = await response.json();
            displayResult(result);
            // formCard.style.display = 'none'; // อาจจะซ่อนฟอร์มไปเลยก็ได้ถ้าต้องการ
            healthForm.reset(); // ล้างค่าในฟอร์มเพื่อการกรอกครั้งต่อไป

        } catch (error) {
            resultContainer.innerHTML = `<p style="color:red; text-align:center;"><strong>เกิดข้อผิดพลาด:</strong> ${error.message}</p>`;
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ส่งประเมินผลอีกครั้ง';
        }
    });

    function displayResult(data) {
        const { userInfo, bmi, assessment } = data;
        
        const createList = (items) => items.map(item => `<li>${item}</li>`).join('');

        const resultHTML = `
            <h2>ผลการประเมินเบื้องต้นสำหรับคุณ ${userInfo.name}</h2>
            
            <div class="result-section">
                <h3>ดัชนีมวลกาย (BMI)</h3>
                <div class="bmi-card" style="background-color: #e8f0fe; color: #174ea6;">
                    BMI ของคุณคือ ${bmi.bmi} <br> จัดอยู่ในเกณฑ์: ${bmi.category}
                </div>
            </div>

            <div class="result-section">
                <h3>บทวิเคราะห์เบื้องต้นจาก AI</h3>
                <p class="primary-analysis">${assessment.primary_analysis || 'ไม่สามารถสร้างบทวิเคราะห์ได้'}</p>
            </div>

            <div class="result-section">
                <h3>ภาวะสุขภาพที่อาจเกี่ยวข้อง</h3>
                <ul>${createList(assessment.possible_conditions || [])}</ul>
            </div>

            <div class="result-section">
                <h3>คำแนะนำในการดูแลตัวเอง</h3>
                 <ul>${createList(assessment.self_care_advice || [])}</ul>
            </div>
            
            <div class="result-section">
                <h3>สัญญาณอันตรายที่ควรรีบไปพบแพทย์</h3>
                 <ul>${createList(assessment.when_to_see_doctor || [])}</ul>
            </div>

            <div class="result-disclaimer">
                ${assessment.disclaimer}
            </div>
        `;
        resultContainer.innerHTML = resultHTML;
    }
</script>

</body>
</html>